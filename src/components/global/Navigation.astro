---
import { Icon } from "astro-icon/components";
import { getLangFromUrl, getUrlWithoutLang, useTranslations, useTranslatedPath } from "@i18n/utils";

const isDev = import.meta.env.DEV;

const lang = getLangFromUrl(Astro.url);
const path = getUrlWithoutLang(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

let pages = [
	{
		title: t("nav.howitworks"),
		url: "/#how-it-works",
		isAnchor: true,
	},
	{
		title: t("nav.features"),
		url: "/#features",
		isAnchor: true,
	},
	{
		title: t("nav.pricing"),
		url: "/#pricing",
		isAnchor: true,
	},
	{
		title: t("nav.faq"),
		url: "/#faq",
		isAnchor: true,
	},
];

const { pathname } = Astro.url;
---

<header>
	<a href={translatePath("/")} aria-label="Home" class="logo absolute z-50 flex h-[4.5rem] items-center md:h-[5.9rem]">
		<div class="flex items-center gap-2">
			<svg viewBox="0 0 40 40" class="h-8 w-8 md:h-10 md:w-10" fill="none" xmlns="http://www.w3.org/2000/svg">
				<circle cx="20" cy="20" r="18" class="stroke-vibe-purple dark:stroke-vibe-yellow" stroke-width="2.5"/>
				<path d="M14 25L20 12L26 25L20 21L14 25Z" class="fill-vibe-purple dark:fill-vibe-yellow"/>
			</svg>
			<span class="font-display text-xl font-bold tracking-tight md:text-2xl">
				<span class="text-vibe-purple dark:text-vibe-yellow">Vibe</span>
				<span class="text-gray-900 dark:text-white"> Cache</span>
			</span>
		</div>
	</a>
	<div data-xdata="{ open: false }" class="navigation fixed right-0 top-0 z-50" data-xbind.class="{'w-full navbar-open': open}">
		<div class="ml-auto md:max-w-fit" data-xbind.class="{'max-w-3xl': open, 'max-w-[8rem]': !open }">
			<div class="mx-auto w-full">
				<div
					class="nav-container relative mx-auto flex w-full flex-col justify-center overflow-x-hidden rounded-xl border border-gray-200 bg-white/80 shadow-sm backdrop-blur-xl dark:border-vibe-purple-700 dark:bg-vibe-purple-800/80 md:flex-row-reverse">
					<div class="flex flex-row items-center justify-end md:hidden">
						<a class="px-3 py-[0.4rem] pl-4 text-vibe-purple transition-colors hover:text-vibe-purple-600 dark:text-vibe-yellow dark:hover:text-vibe-yellow-400" href={translatePath("/contact/")} aria-label="Contact Page">
							<Icon class="" name="octicon:mail-16" width="20" data-xbind.class="{'hidden': open}" />
						</a>
						<button
							data-xon.click="open = !open"
							data-xbind.style="{'padding-top': open ? '1rem' : '0.4rem'}"
							aria-label="Open navbar"
							class="inline-flex items-center justify-center px-3 py-[0.4rem] pr-4 text-gray-700 hover:text-vibe-purple focus:outline-none dark:text-white dark:hover:text-vibe-yellow">
							<svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
								<path
									data-xbind.class="{'hidden': open, 'inline-flex': !open }"
									class="inline-flex"
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M4 6h16M4 12h16M4 18h16">
								</path>
								<path
									data-xbind.class="{'hidden': !open, 'inline-flex': open }"
									class="hidden"
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M6 18L18 6M6 6l12 12">
								</path>
							</svg>
						</button>
					</div>
					<nav data-xbind.class="{'flex': open, 'hidden': !open}" class="hidden flex-grow flex-col justify-center py-12 md:flex md:py-0">
						<ul
							class="flex list-none flex-col items-end justify-center gap-2 px-2 text-center text-3xl md:flex-row md:items-center md:text-sm">
							{
								pages.map((page) => (
									<li data-cursor-hover>
										<a
											href={page.isAnchor ? page.url : translatePath(page.url)}
											class={`nav-link inline-block cursor-pointer px-1 py-[0.33rem]`}>
											<span class="menu-item-container inline-block rounded-lg">
												<span class="menu-item px-3 py-1 font-medium text-gray-600 transition-colors hover:text-vibe-purple dark:text-gray-300 dark:hover:text-white">
													{page.title}
												</span>
											</span>
										</a>
									</li>
								))
							}
							<!-- Dark mode toggle -->
							<li class="hidden md:block">
								<button
									id="theme-toggle"
									aria-label="Toggle dark mode"
									class="ml-2 inline-flex items-center justify-center rounded-lg p-2 text-gray-600 transition-colors hover:bg-gray-100 hover:text-vibe-purple dark:text-gray-300 dark:hover:bg-vibe-purple-700 dark:hover:text-vibe-yellow">
									<!-- Sun icon (shown in dark mode) -->
									<svg class="hidden h-5 w-5 dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
									</svg>
									<!-- Moon icon (shown in light mode) -->
									<svg class="block h-5 w-5 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
									</svg>
								</button>
							</li>
							<li class="hidden md:block">
								<a
									href={translatePath("/contact/")}
									class="ml-2 inline-flex items-center justify-center rounded-lg bg-vibe-purple px-4 py-2 text-sm font-semibold text-white transition-all hover:bg-vibe-purple-600 dark:bg-vibe-yellow dark:text-vibe-purple-900 dark:hover:bg-vibe-yellow-400">
									{t("nav.getstarted")}
								</a>
							</li>
							<li class="md:hidden">
								<a href={translatePath(path, `${lang === "it" ? "en" : "it"}`)} class="inline-block cursor-pointer px-1 py-[0.33rem]">
									<span class="menu-item-container inline-block">
										<span class="menu-item px-4 py-1 font-medium uppercase text-gray-600 hover:text-vibe-purple dark:text-gray-300 dark:hover:text-white">
											{lang === "it" ? "en" : "it"}
										</span>
									</span>
								</a>
							</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
	</div>
</header>

<style>
	.navigation {
		mix-blend-mode: normal;
	}
	.navigation.navbar-open {
		mix-blend-mode: normal;
	}
	.navigation,
	.logo {
		padding: 1rem var(--base-padding-x);
	}
	@media (min-width: 768px) {
		.navigation,
		.logo {
			padding: 2rem var(--base-padding-x);
		}
	}

	nav a.active .menu-item,
	nav a:hover .menu-item {
		color: inherit;
	}
</style>

<script>
	function init() {
		// Theme toggle
		const themeToggle = document.getElementById('theme-toggle');

		// Check for saved preference or default to system preference
		const getThemePreference = () => {
			if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
				return localStorage.getItem('theme');
			}
			return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
		};

		const setTheme = (theme: string) => {
			if (theme === 'dark') {
				document.documentElement.classList.add('dark');
			} else {
				document.documentElement.classList.remove('dark');
			}
			localStorage.setItem('theme', theme);
		};

		// Set initial theme
		setTheme(getThemePreference());

		themeToggle?.addEventListener('click', () => {
			const isDark = document.documentElement.classList.contains('dark');
			setTheme(isDark ? 'light' : 'dark');
		});

		// Smooth scroll for anchor links
		document.querySelectorAll('.nav-link').forEach(link => {
			link.addEventListener('click', function(e) {
				const href = (this as HTMLAnchorElement).getAttribute('href');
				if (href && href.startsWith('/#')) {
					e.preventDefault();
					const targetId = href.substring(2);
					const target = document.getElementById(targetId);
					if (target) {
						target.scrollIntoView({ behavior: 'smooth' });
					}
				}
			});
		});

		// Nav background on scroll
		const navContainer = document.querySelector('.nav-container') as HTMLElement;
		if (navContainer) {
			window.addEventListener('scroll', () => {
				if (window.scrollY > 100) {
					navContainer.style.boxShadow = '0 4px 6px -1px rgb(0 0 0 / 0.1)';
				} else {
					navContainer.style.boxShadow = '0 1px 2px 0 rgb(0 0 0 / 0.05)';
				}
			});
		}
	}

	document.removeEventListener('DOMContentLoaded', init);
	document.addEventListener('DOMContentLoaded', init);
</script>
