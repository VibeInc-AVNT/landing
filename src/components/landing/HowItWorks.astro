---
import { getLangFromUrl, useTranslations } from "@i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const { class: className } = Astro.props;

const steps = [
	{
		step: t("howitworks.1.step"),
		title: t("howitworks.1.title"),
		desc: t("howitworks.1.desc"),
		icon: `<svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/></svg>`,
	},
	{
		step: t("howitworks.2.step"),
		title: t("howitworks.2.title"),
		desc: t("howitworks.2.desc"),
		icon: `<svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>`,
	},
	{
		step: t("howitworks.3.step"),
		title: t("howitworks.3.title"),
		desc: t("howitworks.3.desc"),
		icon: `<svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>`,
	},
	{
		step: t("howitworks.4.step"),
		title: t("howitworks.4.title"),
		desc: t("howitworks.4.desc"),
		icon: `<svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`,
	},
];
---

<section id="how-it-works" class:list={["section relative bg-white py-24 dark:bg-vibe-purple-900 lg:py-32", className]}>
	<div class="relative z-10 col-span-12">
		<!-- Section header -->
		<div class="mx-auto mb-16 max-w-3xl text-center lg:mb-20">
			<h2 class="font-display text-4xl font-bold uppercase text-gray-900 dark:text-white md:text-5xl lg:text-6xl">
				{t("howitworks.title")}
			</h2>
		</div>

		<!-- Steps grid -->
		<div class="mx-auto max-w-5xl">
			<div class="grid gap-8 md:grid-cols-2">
				{steps.map((step, i) => (
					<div
						class="step-item group rounded-2xl border border-gray-200 bg-white p-8 transition-all hover:border-vibe-purple/30 hover:shadow-lg dark:border-vibe-purple-700 dark:bg-vibe-purple-800/50 dark:hover:border-vibe-indigo/50"
						style={`animation-delay: ${i * 0.1}s;`}
					>
						<div class="flex items-start gap-5">
							<!-- Step number -->
							<div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-xl bg-vibe-purple font-display text-xl font-bold text-white dark:bg-vibe-yellow dark:text-vibe-purple-900">
								{step.step}
							</div>

							<div class="flex-1">
								<!-- Title -->
								<h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">
									{step.title}
								</h3>

								<!-- Description -->
								<p class="text-gray-600 dark:text-gray-400">
									{step.desc}
								</p>
							</div>
						</div>
					</div>
				))}
			</div>
		</div>

		<!-- Visual flow diagram -->
		<div class="mx-auto mt-16 max-w-4xl lg:mt-20">
			<div class="overflow-hidden rounded-2xl border border-gray-200 bg-gray-50 p-8 dark:border-vibe-purple-700 dark:bg-vibe-purple-800/30">
				<div class="flex flex-col items-center justify-between gap-6 md:flex-row">
					<!-- Request -->
					<div class="flex flex-col items-center text-center">
						<div class="mb-3 rounded-full border-2 border-vibe-purple/20 bg-vibe-purple-50 p-4 dark:border-vibe-indigo/30 dark:bg-vibe-purple-800/50">
							<svg class="h-8 w-8 text-vibe-purple dark:text-vibe-indigo" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
							</svg>
						</div>
						<span class="text-sm font-medium text-gray-900 dark:text-white">User Request</span>
					</div>

					<!-- Arrow -->
					<svg class="hidden h-6 w-12 text-gray-400 dark:text-gray-600 md:block" fill="none" viewBox="0 0 48 24">
						<path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M0 12h44m0 0l-6-6m6 6l-6 6"/>
					</svg>
					<svg class="block h-12 w-6 text-gray-400 dark:text-gray-600 md:hidden" fill="none" viewBox="0 0 24 48">
						<path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 0v44m0 0l-6-6m6 6l6-6"/>
					</svg>

					<!-- Vibe Cache -->
					<div class="flex flex-col items-center text-center">
						<div class="mb-3 rounded-full bg-vibe-purple p-4 dark:bg-vibe-yellow">
							<svg class="h-8 w-8 text-white dark:text-vibe-purple-900" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
							</svg>
						</div>
						<span class="text-sm font-medium text-gray-900 dark:text-white">Vibe Cache</span>
						<span class="text-xs text-gray-500 dark:text-gray-400">Semantic Matching</span>
					</div>

					<!-- Branch arrows -->
					<div class="flex flex-col items-center gap-4">
						<div class="flex items-center gap-2">
							<svg class="hidden h-6 w-8 text-green-500 md:block" fill="none" viewBox="0 0 32 24">
								<path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M0 12h28m0 0l-6-6m6 6l-6 6"/>
							</svg>
							<span class="text-xs font-medium text-green-600 dark:text-green-400">Cache Hit: 50ms</span>
						</div>
						<div class="flex items-center gap-2">
							<svg class="hidden h-6 w-8 text-gray-400 md:block" fill="none" viewBox="0 0 32 24">
								<path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M0 12h28m0 0l-6-6m6 6l-6 6"/>
							</svg>
							<span class="text-xs font-medium text-gray-500">Cache Miss: LLM</span>
						</div>
					</div>

					<!-- Response -->
					<div class="flex flex-col items-center text-center">
						<div class="mb-3 rounded-full border-2 border-green-500/20 bg-green-50 p-4 dark:border-green-400/30 dark:bg-green-400/10">
							<svg class="h-8 w-8 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
							</svg>
						</div>
						<span class="text-sm font-medium text-gray-900 dark:text-white">Response</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<style>
	.step-item {
		animation: fadeInUp 0.6s ease-out both;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>

<script>
	function init() {
		const items = document.querySelectorAll('.step-item');

		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						(entry.target as HTMLElement).style.animationPlayState = 'running';
					}
				});
			},
			{ threshold: 0.2 }
		);

		items.forEach((item) => {
			(item as HTMLElement).style.animationPlayState = 'paused';
			observer.observe(item);
		});
	}

	document.removeEventListener('DOMContentLoaded', init);
	document.addEventListener('DOMContentLoaded', init);
</script>
