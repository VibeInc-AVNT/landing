---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import yourProjectImage from "@assets/images/projects/yourProject.png";
import WokCard from "@components/work/WokCard.astro";
import { getLangFromUrl, useTranslatedPath, useTranslations } from "@i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const { class: className } = Astro.props;

const allProjects = (await getCollection("projects"))
	.filter((prj) => {
		const [postLang, ...slug] = prj.slug.split("/");
		return postLang === lang;
	})
	.map((prj) => {
		const [postLang, slug] = prj.slug.split("/");

		return {
			...prj,
			slug: slug,
		};
	})
	.sort((a, b) => Number(b.data.pubDate) - Number(a.data.pubDate));
---

<section id="projects" class:list={["section work-preview-section home-dark-section py-12", className]}>
	<div class="col-span-12 col-start-1 mx-auto max-w-7xl">
		<h2 class="sr-only">{t("projects")}</h2>
		<ol class="grid grid-cols-1 gap-24 md:grid-cols-2 lg:gap-44">
			{
				allProjects.map((project, index) => (
					<WokCard
						image={project.data.image.source}
						project={project.data.title}
						link={`/work/${project.slug}`}
						class={
							index % 2 === 0
								? `md:col-start-1 md:row-start-${Math.floor(index / 2) * 2 + 1} md:row-span-2`
								: `md:col-start-2 md:row-start-${Math.floor(index / 2) * 2 + 2} md:row-span-2`
						}
					/>
				))
			}
		</ol>
	</div>
</section>

<style is:global>
	.work-preview-section ol li img {
		--clip: 0%;
		clip-path: inset(var(--clip) round 0.5rem);
	}
</style>

<script>
	// GSAP-free fallbacks for preview clipping, background change and project parallax
	function init() {
		const previews = Array.from(document.querySelectorAll('.work-preview-section ol li img'));
		const projects = Array.from(document.querySelectorAll('.work-preview-section ol li'));
		const wrapper = document.querySelector('.work-preview-section');

		const previewObserver = new IntersectionObserver(entries => {
			entries.forEach(entry => {
				const el = entry.target;
				const rect = el.getBoundingClientRect();
				const winH = window.innerHeight || document.documentElement.clientHeight;
				const progress = Math.max(0, Math.min(1, (winH - rect.top) / (rect.height + winH)));
				const clipVal = Math.max(0, 30 * (1 - progress));
				el.style.setProperty('--clip', `${clipVal}%`);
			});
		}, { threshold: Array.from({ length: 11 }, (_, i) => i / 10) });

		previews.forEach(p => previewObserver.observe(p));

		// Background color toggle for the work-preview-section
		const bgObserver = new IntersectionObserver(entries => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					wrapper?.classList.add('scrolled-in');
				} else {
					wrapper?.classList.remove('scrolled-in');
				}
			});
		}, { threshold: 0.5 });
		if (wrapper) bgObserver.observe(wrapper);

		// Simple parallax for large screens
		if (window.innerWidth >= 768) {
			let ticking = false;
			function onScroll() {
				if (ticking) return;
				ticking = true;
				requestAnimationFrame(() => {
					const rect = wrapper.getBoundingClientRect();
					const winH = window.innerHeight || document.documentElement.clientHeight;
					const progress = Math.max(0, Math.min(1, (winH - rect.top) / (rect.height + winH)));
					const y = -200 * progress;
					projects.forEach(p => { p.style.transform = `translateY(${y}px)`; p.style.transition = 'transform 200ms linear'; });
					ticking = false;
				});
			}

			document.addEventListener('scroll', onScroll, { passive: true });
			onScroll();
		}
	}

	document.removeEventListener('DOMContentLoaded', init); // astro:page-load
	document.addEventListener('DOMContentLoaded', init); // astro:page-load
</script>
